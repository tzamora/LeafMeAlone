<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
    <title></title>

    <!--<link href="lib/ionic/css/ionic.css" rel="stylesheet">-->

      <!--Import materialize.css-->
      <link type="text/css" rel="stylesheet" href="materialize-css/bin/materialize.css"  media="screen,projection"/>
      <link type="text/css" rel="stylesheet" href="css/app.css" media="screen,projection"/>

    <!-- IF using Sass (run gulp sass first), then uncomment below and remove the CSS includes above
    <link href="css/ionic.app.css" rel="stylesheet">
    -->

    <!-- ionic/angularjs js -->
    <script src="lib/ionic/js/ionic.bundle.js"></script>

    <!-- cordova script (this will be a 404 during development) -->
    <script src="cordova.js"></script>

    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="materialize-css/bin/materialize.js"></script>
    <script src="https://www.dropbox.com/static/api/dropbox-datastores-1.2-latest.js" type="text/javascript"></script>
    <!-- google maps javascript -->
    <!--<script src="//maps.googleapis.com/maps/api/js?key=AIzaSyBcl0Jnr78DekYfQ35obqd-DPw2Apxv00w&sensor=true"></script>-->
  </head>

  <body>

  <!-- BODY -->

  <nav>
      <div class="nav-wrapper">
          <ul id="nav-mobile" class="left">
              <li><a data-launch-view="camera" href="#camera"><i class="mdi-image-photo-camera"></i></a></li>
              <li><a data-launch-view="confirmation" href="#confirmation"><i class="mdi-editor-insert-chart"></i></a></li>รง
              <li><a onclick="loadGallery()" data-launch-view="gallery" href="#gallery"><i class="mdi-image-editor-camera"></i></a></li>
          </ul>
      </div>
  </nav>

  <div id="lotOfPages">

    <div class="view" id="camera">
      <h5>Page 1</h5>
      <footer class="fixed-footer">
          <a class="btn-floating btn-large waves-effect waves-light red right margin small-right-margin" href="#" onclick="takePicture()">
              <i class="mdi-image-photo-camera"></i>
          </a>
          <a class="btn-floating btn-large waves-effect waves-light green right margin small-right-margin" href="#" onclick="getPicture()">
              <i class="mdi-image-photo-camera"></i>
          </a>
      </footer>
    </div>

    <div class="view" id="confirmation" style="display:none;">

        <div class="row">
            <div class="col s12">
                <h5>Submit</h5>
            </div>
        </div>
        <div class="center-align">
            <img id="result_image" src="img/ionic.png" style="width: 200px; height:200px;" />
        </div>
        <div class="row">
            <div class="input-field col s12">
                <input id="description" type="text" >
                <label for="description">Description</label>
            </div>
        </div>

        <!-- map -->
        <div class="row">
            <div id="map_canvas" data-tap-disabled="true" class="map">
            </div>
            <div class="input-field col s12">
                <input id="coord" type="text" >
                <label for="coord">Coordenadas</label>
            </div>
        </div>

        <div class="row">
            <button class="btn waves-effect waves-light con s12" type="submit" name="action" onclick="saveInformation();">Submit
                <i class="mdi-content-send right"></i>
            </button>
        </div>

    </div>

    <div class="view" id="gallery">

    </div>

  </div>

  <!-- Modal Structure -->
  <div id="modal1" class="modal">
      <div class="modal-content">
          <h4>Leaf Preview</h4>
          <p>Damage: <span id="damagePercent">0%</span></p>
          <img id="analizedPhoto" src="img/ionic.png" />
      </div>
      <div class="modal-footer">
          <a class=" modal-action modal-close waves-effect waves-green btn-flat" href="#" >Submit</a>
          <!--<a href="#!" class=" modal-action modal-close waves-effect waves-green btn-flat">Cancel</a>-->
      </div>
  </div>


  <script type="text/javascript">

    var map, mapOptions, currentLocation, currentLocationMarker, db;

    document.addEventListener("deviceready", onDeviceReady, false);

    var self = this;

    $(document).ready(function (e) {

        self.loadInformation();

        function showView(viewName) {
            $('.view').hide();
            $('#' + viewName).show();
        }

        $('[data-launch-view]').click(function (e) {
            e.preventDefault();
            var viewName = $(this).attr('data-launch-view');
            showView(viewName);
        });

        function showMapView(){
            showView('confirmation');
        }
    });

    function getPicture(){
        navigator.camera.getPicture(function(imageURI) {

            var image = document.getElementById('result_image');
            image.src = "data:image/jpeg;base64," + imageURI;

            $('#modal1').openModal();

        }, function(err) {

            alert('Error: ' + err);

        },{
            quality: 20,
            destinationType: Camera.DestinationType.DATA_URL,
            sourceType: Camera.PictureSourceType.SAVEDPHOTOALBUM,
            correctOrientation: true
        });
    }

    function takePicture() {

        navigator.camera.getPicture(function(imageURI) {

            var image = document.getElementById('result_image');
            image.src = "data:image/jpeg;base64," + imageURI;

            $('#modal1').openModal();

        }, function(err) {

            alert('Error: ' + err);

      }, {
            quality: 20,
            destinationType: Camera.DestinationType.DATA_URL,
            sourceType: Camera.PictureSourceType.CAMERA,
            correctOrientation: true
        });
    }

    function loadMapScript() {
        var script = document.createElement("script");
        script.type = "text/javascript";
        script.id = "googleMaps"
        script.src = "https://maps.googleapis.com/maps/api/js?sensor=false&callback=initializeMap";
        document.body.appendChild(script);
    }

    function initializeMap(mapOptions) {
        var myLatlng = new google.maps.LatLng(currentLocation.coords.latitude, currentLocation.coords.longitude);
        var mapOptions = {
            center : myLatlng,
            zoom : 18,
            mapTypeId : google.maps.MapTypeId.ROADMAP
        };
        map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);

        updateCurrentLocationMarker();
    }

    function updateCurrentLocationMarker() {
        var myLatlng = new google.maps.LatLng(currentLocation.coords.latitude, currentLocation.coords.longitude);

        if (currentLocationMarker) {
            currentLocationMarker.setMap(null);
        } else {
            currentLocationMarker = new google.maps.Marker({
                position : myLatlng,
                animation : google.maps.Animation.DROP,
                title : "You!",
                map : map
            });

            $('#coord').val( currentLocation.coords.latitude + ', ' + currentLocation.coords.longitude);

        }
    }

    function onSuccess(position) {
        currentLocation = position;
        if (!map) {
            loadMapScript();
        }
    }

    function onError(error) {
        alert('code: ' + error.code + '\n' + 'message: ' + error.message + '\n');
    }

    function onDeviceReady() {
        navigator.geolocation.getCurrentPosition(onSuccess, onError);
    }


    function saveInformation() {
      if (typeof(Storage) !== "undefined") {
        var data = { 
          "latitude": currentLocation.coords.latitude, 
          "longitude": currentLocation.coords.longitude, 
          "description": document.getElementById('description').value,
          "injured": document.getElementById('damagePercent').value
        };

        db.push(data);

        localStorage["leaf"] = JSON.stringify(db);
      }
    }

    function loadInformation() {
      
      if (typeof(Storage) !== "undefined") {

        if (localStorage["leaf"] !== undefined) {
          db = JSON.parse(localStorage["leaf"]);
        }
        else {
          db = [];
        }
      }
    }

    function loadGallery () {
      $.each(db, function(i, obj) {
        var mainDiv = document.createElement("div");
        mainDiv.className = "card";

        var imageDiv = document.createElement("div");
        imageDiv.className = "card-image waves-effect waves-block waves-light";
        var image = document.createElement("img");
        image.className = "activator";
        //<image.src("images/office.jpg");
        imageDiv.appendChild(image);

        var contentDiv = document.createElement("div");
        contentDiv.className = "card-content";
        var contentSpan = document.createElement("span");
        contentSpan.className = "card-title activator grey-text text-darken-4";
        contentSpan.innerHTML = obj.injured;
        var contentPar = document.createElement("p");
        contentPar.innerHTML = obj.latitude + ', ' + obj.longitude;
        contentDiv.appendChild(contentPar);
        contentDiv.appendChild(contentSpan);

        document.getElementById("gallery").appendChild(imageDiv);
        document.getElementById("gallery").appendChild(contentDiv);

      });

    }

  </script>
  <!--Import jQuery before materialize.js-->

  </body>
</html>
