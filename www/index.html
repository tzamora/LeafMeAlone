<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
    <title></title>

    <!--<link href="lib/ionic/css/ionic.css" rel="stylesheet">-->

      <!--Import materialize.css-->
      <link type="text/css" rel="stylesheet" href="materialize-css/bin/materialize.css"  media="screen,projection"/>
      <link type="text/css" rel="stylesheet" href="css/app.css" media="screen,projection"/>

    <!-- IF using Sass (run gulp sass first), then uncomment below and remove the CSS includes above
    <link href="css/ionic.app.css" rel="stylesheet">
    -->

    <!-- ionic/angularjs js -->
    <script src="lib/ionic/js/ionic.bundle.js"></script>

    <!-- cordova script (this will be a 404 during development) -->
    <script src="cordova.js"></script>

    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="materialize-css/bin/materialize.js"></script>
    <!-- google maps javascript -->
    <!--<script src="//maps.googleapis.com/maps/api/js?key=AIzaSyBcl0Jnr78DekYfQ35obqd-DPw2Apxv00w&sensor=true"></script>-->
  </head>

  <body>

  <!-- BODY -->

  <nav>
      <div class="nav-wrapper">
          <ul id="nav-mobile" class="left">
              <li><a data-launch-view="camera" href="#camera"><i class="mdi-image-photo-camera"></i></a></li>
              <!--<li><a data-launch-view="confirmation" href="#confirmation"><i class="mdi-editor-insert-chart"></i></a></li>-->
              <li><a data-launch-view="gallery" href="#gallery" onclick="loadGallery()"><i class="mdi-image-collections"></i></a></li>
              <li><a data-launch-view="help" href="#help" ><i class="mdi-action-help"></i></a></li>
              <li><a data-launch-view="about" href="#about" ><i class="mdi-action-info"></i></a></li>

          </ul>
      </div>
  </nav>

  <div id="views">

    <div class="view" id="camera">
      <div class="row">
          <div class="center-align">
              <h5>Load an image</h5>
              <div id="progressBar" class="progress" style="display: none">
                  <div class="indeterminate"></div>
              </div>
              <img id="processedImage" src="img/ionic.png" style="width: 90%; height:auto;" />
              <div id="imageInfo" class="row">
                  <h5><span style="color: darkred">Damage: </span><span class="damagePercent"></span></h5>
                  <button id="submitLeafButton" class="btn waves-effect waves-light" onclick="showView('confirmation');" type="submit" name="action">Save</button>
                  <img id="hidden_image" src="img/ionic.png" style="position:absolute; visibility: hidden;" />
              </div>
          </div>
      </div>

      <footer class="fixed-footer">
          <a class="btn-floating btn-large waves-effect waves-light red right margin small-right-margin" href="#" onclick="takePicture()">
              <i class="mdi-image-photo-camera"></i>
          </a>
          <a class="btn-floating btn-large waves-effect waves-light green right margin small-right-margin" href="#" onclick="getPicture()">
              <i class="mdi-image-crop-original"></i>
          </a>
      </footer>
    </div>

    <div class="view" id="confirmation" style="display:none;">

        <div class="row">
            <div class="col s12">
                <h5>Submit</h5>
            </div>
        </div>
        <div class="center-align">
            <img id="new_image" src="img/ionic.png" style="width: 90%; height:auto;" />
            <h5><span style="color: darkred">Damage: </span><span class="damagePercent"></span></h5>
        </div>

        <div class="row">
            <div class="input-field col s12">
                <input id="description" type="text" >
                <label for="description">Description</label>
            </div>
        </div>

        <!-- map -->
        <div class="row">
            <div id="map_canvas" data-tap-disabled="true" class="map">
            </div>
            <div class="input-field col s12">
                <input id="coord" type="text" class="validate">
                <label id="coordLabel" class="active" for="coord">Coordenadas</label>
            </div>
        </div>

        <div class="row">
            <button class="btn waves-effect waves-light con s12" type="submit" name="action">Submit
                <i class="mdi-content-send right"></i>
            </button>
        </div>

    </div>

    <div class="view" id="data" style="display:none">
        <h1>Page 3</h1>
    </div>

    <div class="view" id="about" style="display:none">
        <div class="row">
            <div class="col s12 m7">
                <div class="card">
                    <div class="card-image">
                        <img src="img/about_leaf.jpg">
                        <span class="card-title">O3 Injury Detection</span>
                    </div>
                    <div class="card-content">
                        <p>Descripcion del proyecto.</p>
                    </div>
                    <div class="card-action">
                        <div class="row">
                            Developer: Jose Mario<br>
                            Developer: Rafa<br>
                            Developer: Jeancarlo <br>
                            Developer: Antonio Zamora<br>
                            <br>
                            Space App Challenge 2015. ITCR, Costa Rica.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

  </div>

  <script type="text/javascript">

    var map, mapOptions, currentLocation, currentLocationMarker;

    document.addEventListener("deviceready", onDeviceReady, false);

    function showView(viewName) {
        $('.view').hide();
        $('#' + viewName).show();
    }

    $(document).ready(function (e) {

        $('[data-launch-view]').click(function (e) {
            e.preventDefault();
            var viewName = $(this).attr('data-launch-view');
            showView(viewName);
        });

        function showMapView(){
            showView('confirmation');
        }

        toogleMainViewInfo(false);

    });

    function toogleMainViewInfo(toggle){

        // if the leaf is not loaded then hide the info

        if(toggle){
            $("#processedImage").show();
            $("#imageInfo").show();
        }else{
            $("#processedImage").hide();
            $("#imageInfo").hide();
        }


    }

    function getPicture(){

        navigator.camera.getPicture(function(imageURI){

            $('#progressBar').show();

            var image = document.getElementById('new_image');

            var hiddenImage = document.getElementById('hidden_image');

            image.src = "data:image/jpeg;base64," + imageURI;

            hiddenImage.src = "data:image/jpeg;base64," + imageURI;

            postImageData(hiddenImage);

        }, function(err) {

            alert('Error: ' + err);

        },{
            quality: 20,
            destinationType: Camera.DestinationType.DATA_URL,
            sourceType: Camera.PictureSourceType.SAVEDPHOTOALBUM,
            correctOrientation: true
        });
    }

    function takePicture() {

        navigator.camera.getPicture(function(imageURI) {

            $('#progressBar').show();

            var image = document.getElementById('new_image');

            var hiddenImage = document.getElementById('hidden_image');

            image.src = "data:image/jpeg;base64," + imageURI;

            hiddenImage.src = "data:image/jpeg;base64," + imageURI;

            postImageData(hiddenImage);

        }, function(err) {

            alert('Error: ' + err);

      }, {
            quality: 20,
            destinationType: Camera.DestinationType.DATA_URL,
            sourceType: Camera.PictureSourceType.CAMERA,
            correctOrientation: true
        });
    }

    function loadMapScript() {
        var script = document.createElement("script");
        script.type = "text/javascript";
        script.id = "googleMaps"
        script.src = "https://maps.googleapis.com/maps/api/js?sensor=false&callback=initializeMap";
        document.body.appendChild(script);
    }

    function initializeMap(mapOptions) {

        var myLatlng = new google.maps.LatLng(currentLocation.coords.latitude, currentLocation.coords.longitude);
        var mapOptions = {
            center : myLatlng,
            zoom : 18,
            mapTypeId : google.maps.MapTypeId.ROADMAP
        };

        map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);

        updateCurrentLocationMarker();
    }

    function updateCurrentLocationMarker() {
        var myLatlng = new google.maps.LatLng(currentLocation.coords.latitude, currentLocation.coords.longitude);

        if (currentLocationMarker) {
            currentLocationMarker.setMap(null);
        } else {
            currentLocationMarker = new google.maps.Marker({
                position : myLatlng,
                animation : google.maps.Animation.DROP,
                title : "You!",
                map : map
            });

            $('#coord').val( currentLocation.coords.latitude + ', ' + currentLocation.coords.longitude);

            $('#coordLabel').attr('class','active');

        }
    }

    function onSuccess(position) {
        currentLocation = position;
        if (!map) {
            loadMapScript();
        }
    }

    function onError(error) {
        alert('code: ' + error.code + '\n' + 'message: ' + error.message + '\n');
    }

    function onDeviceReady() {
        navigator.geolocation.getCurrentPosition(onSuccess, onError);
    }

    function postImageData(img){

        var myBase64EncodedData  = getBase64Image(img);

        $.ajax({
            type: 'POST',
            url: 'http://172.26.7.216:8080/',
            data: {
                'image': myBase64EncodedData
            },
            success: function(data){

                var response = JSON.parse(data);

                $('.damagePercent').html(response.damage_percentage);

                var processedImage = document.getElementById('processedImage');

                processedImage.src = "data:image/jpeg;base64," + response.result_image;

                var new_image = document.getElementById('new_image');

                new_image.src = "data:image/jpeg;base64," + response.result_image;

                $('#progressBar').hide();

                toogleMainViewInfo(true);
            }
        });
    }

    function getBase64Image(img) {
        // Create an empty canvas element
        var canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;

        // Copy the image contents to the canvas
        var ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);

        // Get the data-URL formatted image
        // Firefox supports PNG and JPEG. You could check img.src to
        // guess the original format, but be aware the using "image/jpg"
        // will re-encode the image.
        var dataURL = canvas.toDataURL("image/png");

        return dataURL.replace(/^data:image\/(png|jpg);base64,/, "");
    }

  </script>
  <!--Import jQuery before materialize.js-->

  </body>
</html>
