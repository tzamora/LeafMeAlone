<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
    <title></title>

    <!--<link href="lib/ionic/css/ionic.css" rel="stylesheet">-->

      <!--Import materialize.css-->
      <link type="text/css" rel="stylesheet" href="materialize-css/bin/materialize.css"  media="screen,projection"/>
      <link type="text/css" rel="stylesheet" href="css/app.css" media="screen,projection"/>

    <!-- IF using Sass (run gulp sass first), then uncomment below and remove the CSS includes above
    <link href="css/ionic.app.css" rel="stylesheet">
    -->

    <!-- ionic/angularjs js -->
    <script src="lib/ionic/js/ionic.bundle.js"></script>

    <!-- cordova script (this will be a 404 during development) -->
    <script src="cordova.js"></script>

    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="materialize-css/bin/materialize.js"></script>
    <script src="https://www.dropbox.com/static/api/dropbox-datastores-1.2-latest.js" type="text/javascript"></script>
    <!-- google maps javascript -->
    <!--<script src="//maps.googleapis.com/maps/api/js?key=AIzaSyBcl0Jnr78DekYfQ35obqd-DPw2Apxv00w&sensor=true"></script>-->
  </head>

  <body>

  <!-- BODY -->

  <nav>
      <div class="nav-wrapper">
          <ul id="nav-mobile" class="left">
              <li><a data-launch-view="camera" href="#camera"><i class="mdi-image-photo-camera"></i></a></li>
              <li><a data-launch-view="confirmation" href="#confirmation"><i class="mdi-editor-insert-chart"></i></a></li>
          </ul>
      </div>
  </nav>

  <div id="lotOfPages">

    <div class="view" id="camera">
      <div class="row">
          <div class="center-align">
              <h5>Load an image</h5>
              <img id="processedImage" src="img/ionic.png" style="width: 200px; height:200px;" />
              <div class="row">
                  <h5><span style="color: darkred">Damage: </span><span class="damagePercent"></span></h5>
                  <button class="btn waves-effect waves-light" type="submit" name="action">Save</button>
                  <img id="hidden_image" src="img/ionic.png" style="position:absolute; visibility: hidden;" />
              </div>
          </div>
      </div>

      <footer class="fixed-footer">
          <a class="btn-floating btn-large waves-effect waves-light red right margin small-right-margin" href="#" onclick="takePicture()">
              <i class="mdi-image-photo-camera"></i>
          </a>
          <a class="btn-floating btn-large waves-effect waves-light green right margin small-right-margin" href="#" onclick="getPicture()">
              <i class="mdi-image-photo-camera"></i>
          </a>
      </footer>
    </div>

    <div class="view" id="confirmation" style="display:none;">

        <div class="row">
            <div class="col s12">
                <h5>Submit</h5>
            </div>
        </div>
        <div class="center-align">
            <img id="new_image" src="img/ionic.png" style="width: 200px; height:200px;" />
            <h5><span style="color: darkred">Damage: </span><span class="damagePercent"></span></h5>
        </div>



        <div class="row">
            <div class="input-field col s12">
                <input id="description" type="text" >
                <label for="description">Description</label>
            </div>
        </div>

        <!-- map -->
        <div class="row">
            <div id="map_canvas" data-tap-disabled="true" class="map">
            </div>
            <div class="input-field col s12">
                <input id="coord" type="text" class="validate">
                <label class="active" for="coord">Coordenadas</label>
            </div>
        </div>

        <div class="row">
            <button class="btn waves-effect waves-light con s12" type="submit" name="action">Submit
                <i class="mdi-content-send right"></i>
            </button>
        </div>

    </div>

    <div class="view" id="data" style="display:none">
        <h1>Page 3</h1>
    </div>

  </div>

  <!--&lt;!&ndash; Modal Structure &ndash;&gt;-->
  <!--<div id="modal1" class="modal">-->
      <!--<div class="modal-content">-->
          <!--<h4>Leaf Preview</h4>-->

          <!--<div class="center-align">-->
            <!--<img id="analizedPhoto" src="img/ionic.png" style="width: 98%" />-->
              <!--<p>Damage: <span id="damagePercent">0%</span></p>-->
          <!--</div>-->
      <!--</div>-->
      <!--<div class="modal-footer">-->
          <!--<a href="#!" class=" modal-action modal-close waves-effect waves-green btn-flat">Submit</a>-->
          <!--<a href="#!" class=" modal-action modal-close waves-effect waves-green btn-flat">Cancel</a>-->
      <!--</div>-->
  <!--</div>-->


  <script type="text/javascript">

    var map, mapOptions, currentLocation, currentLocationMarker;

    document.addEventListener("deviceready", onDeviceReady, false);


    $(document).ready(function (e) {

        function showView(viewName) {
            $('.view').hide();
            $('#' + viewName).show();
        }

        $('[data-launch-view]').click(function (e) {
            e.preventDefault();
            var viewName = $(this).attr('data-launch-view');
            showView(viewName);
        });

        function showMapView(){
            showView('confirmation');
        }
        onDeviceReady();

    });

    function getPicture(){

        var img = document.getElementById('new_image');

        navigator.camera.getPicture(function(imageURI){

            var image = document.getElementById('new_image');

            var hiddenImage = document.getElementById('hidden_image');

            image.src = "data:image/jpeg;base64," + imageURI;

            hiddenImage.src = "data:image/jpeg;base64," + imageURI;

            postImageData(hiddenImage);

        }, function(err) {

            alert('Error: ' + err);

        },{
            quality: 20,
            destinationType: Camera.DestinationType.DATA_URL,
            sourceType: Camera.PictureSourceType.SAVEDPHOTOALBUM,
            correctOrientation: true
        });
    }

    function takePicture() {

        navigator.camera.getPicture(function(imageURI) {

            var image = document.getElementById('new_image');

            var hiddenImage = document.getElementById('hidden_image');

            image.src = "data:image/jpeg;base64," + imageURI;

            hiddenImage.src = "data:image/jpeg;base64," + imageURI;

            postImageData(hiddenImage);

            $('#modal1').openModal();

        }, function(err) {

            alert('Error: ' + err);

      }, {
            quality: 20,
            destinationType: Camera.DestinationType.DATA_URL,
            sourceType: Camera.PictureSourceType.CAMERA,
            correctOrientation: true
        });
    }

    function loadMapScript() {
        var script = document.createElement("script");
        script.type = "text/javascript";
        script.id = "googleMaps"
        script.src = "https://maps.googleapis.com/maps/api/js?sensor=false&callback=initializeMap";
        document.body.appendChild(script);
    }

    function initializeMap(mapOptions) {

        var myLatlng = new google.maps.LatLng(currentLocation.coords.latitude, currentLocation.coords.longitude);
        var mapOptions = {
            center : myLatlng,
            zoom : 18,
            mapTypeId : google.maps.MapTypeId.ROADMAP
        };

        map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);

        updateCurrentLocationMarker();
    }

    function updateCurrentLocationMarker() {
        var myLatlng = new google.maps.LatLng(currentLocation.coords.latitude, currentLocation.coords.longitude);

        if (currentLocationMarker) {
            currentLocationMarker.setMap(null);
        } else {
            currentLocationMarker = new google.maps.Marker({
                position : myLatlng,
                animation : google.maps.Animation.DROP,
                title : "You!",
                map : map
            });

            $('#coord').val( currentLocation.coords.latitude + ', ' + currentLocation.coords.longitude);

        }
    }

    function onSuccess(position) {
        currentLocation = position;
        if (!map) {
            loadMapScript();
        }
    }

    function onError(error) {
        alert('code: ' + error.code + '\n' + 'message: ' + error.message + '\n');
    }

    function onDeviceReady() {
        navigator.geolocation.getCurrentPosition(onSuccess, onError);
    }

    function uploadPhoto(imageURI) {

        alert('---> ' + imageURI);

        var options = new FileUploadOptions();
        options.fileKey="file";
        options.fileName=imageURI.substr(imageURI.lastIndexOf('/')+1)+'.png';
        options.mimeType="text/plain";

        var params = new Object();

        options.params = params;

        var ft = new FileTransfer();

        ft.upload(imageURI, encodeURI("http://172.26.7.216:8080/"), win, fail, options);
    }

    function win(r) {
        alert('lo logramos');
        console.log("Code = " + r.responseCode);
        console.log("Response = " + r.response);
        console.log("Sent = " + r.bytesSent);
    }

    function fail(error) {
        alert("An error has occurred: Code = " + error.code);
        console.log("upload error source " + error.source);
        console.log("upload error target " + error.target);
    }

    function postImageData(img){

        var myBase64EncodedData  = getBase64Image(img);

        $.ajax({
            type: 'POST',
            url: 'http://172.26.7.216:8080/',
            data: {
                'image': myBase64EncodedData
            },
            success: function(data){

                $('.damagePercent').vale(data.damage_percentage);

                var processedImage = document.getElementById('new_image');

                processedImage.src = "data:image/jpeg;base64," + data.result_image;

            }
        });
    }

    function getBase64Image(img) {
        // Create an empty canvas element
        var canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;

        // Copy the image contents to the canvas
        var ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);

        // Get the data-URL formatted image
        // Firefox supports PNG and JPEG. You could check img.src to
        // guess the original format, but be aware the using "image/jpg"
        // will re-encode the image.
        var dataURL = canvas.toDataURL("image/png");

        return dataURL.replace(/^data:image\/(png|jpg);base64,/, "");
    }

  </script>
  <!--Import jQuery before materialize.js-->

  </body>
</html>
